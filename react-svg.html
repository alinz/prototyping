<!DOCTYPE html>
<html>
<head>
  <title>react + svg test</title>
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: hsl(0, 0%, 10%);
      font-family: monospace;
      overflow: hidden;
      color: white;
    }
    a {
      color: white;
    }
    svg {
    }
    rect {
      fill: hsla(0, 0%, 0%, 0.75);
      stroke: hsl(0, 0%, 50%);
      stroke-width: 1px;
    }
    path.edge-bg {
      fill: none;
      stroke: black;
      stroke-width: 4px;
    }
    path.edge-fg {
      fill: none;
      stroke: white;
      stroke-width: 2px;
    }
    text {
      font-size: 10px;
      fill: white;
      text-anchor: middle;
    }
  </style>
  <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.8.0/react.js"></script>
  <script type="text/javascript">
  (function(){
    "use strict";

    var NofloNode = React.createClass({
      render: function() {
        var label = this.props.process.metadata.label;
        if (label === undefined || label === "") {
          label = this.props.name
        }
        var x = this.props.process.metadata.x;
        var y = this.props.process.metadata.y;
        return (
          React.DOM.g(
            {
              name: label,
              transform: "translate("+x+","+y+")"
            },
            React.DOM.rect({
              width: 72,
              height: 72,
              rx: 8,
              ry: 8
            }),
            React.DOM.text({
              x: 36,
              y: 92,
              children: label
            })
          )
        );
      }
    });

    var NofloEdge = React.createClass({
      componentWillMount: function() {
        // Todo: listen for source/target moving; change state
      },
      render: function() {
        var sourceX = this.props.source.metadata.x + 72;
        var sourceY = this.props.source.metadata.y + 36;
        var targetX = this.props.target.metadata.x + 0;
        var targetY = this.props.target.metadata.y + 36;
        var curve = 50;
        var path = [
          "M",
          sourceX, sourceY,
          "C",
          sourceX + curve, sourceY,
          targetX - curve, targetY,
          targetX, targetY
        ].join(" ");
        return (
          React.DOM.g(
            {className: "edge"},
            React.DOM.path({
              className: "edge-bg",
              d: path
            }),
            React.DOM.path({
              className: "edge-fg",
              d: path
            })
          )
        );
      }
    });

    var NofloGraph = React.createClass({
      minZoom: 0.04,
      getInitialState: function() {
        return {
          x: 0,
          y: 0,
          scale: 1,
          graph: this.props.graph
        };
      },
      onWheel: function (event) {
        if (this.keyPan) {
          this.setState({
            x: this.state.x - event.deltaX,
            y: this.state.y + event.deltaY
          });
        } else {
          var scale = this.state.scale + (this.state.scale * event.deltaY/500);
          if (scale < this.minZoom) { return; }

          // Zoom and pan transform-origin equivalent
          var scaleD = scale / this.state.scale;
          var currentX = this.state.x;
          var currentY = this.state.y;
          var oX = this.mouseX;
          var oY = this.mouseY;
          var x = scaleD * (currentX - oX) + oX;
          var y = scaleD * (currentY - oY) + oY;

          this.setState({
            scale: scale,
            x: x,
            y: y
          });
        }
      },
      keyPan: false,
      onKeyUpDown: function (event) {
        // Don't scroll with space
        event.preventDefault();
        // console.log(event);
        if (event.keyCode === 32 /* space */) {
          this.keyPan = (event.type === "keydown");
        }
      },
      mouseX: 0,
      mouseY: 0,
      mousePressed: false,
      onMouseDown: function (event) {
        this.mousePressed = true;
        this.mouseX = event.pageX;
        this.mouseY = event.pageY;
      },
      onMouseMove: function (event) {
        // Pan
        if (this.mousePressed) {
          var deltaX = event.pageX - this.mouseX;
          var deltaY = event.pageY - this.mouseY;
          this.setState({
            x: this.state.x + deltaX,
            y: this.state.y + deltaY
          });
        }
        this.mouseX = event.pageX;
        this.mouseY = event.pageY;
      },
      onMouseUp: function (event) {
        this.mousePressed = false;
      },
      componentDidMount: function () {
        window.addEventListener("keydown", this.onKeyUpDown);
        window.addEventListener("keyup", this.onKeyUpDown);

        // Mouse listen to window for drag/release outside
        window.addEventListener("mousedown", this.onMouseDown);
        window.addEventListener("mousemove", this.onMouseMove);
        window.addEventListener("mouseup", this.onMouseUp);

        // Start zoom from middle if zoom before mouse move
        this.mouseX = Math.floor( window.innerWidth/2 );
        this.mouseY = Math.floor( window.innerHeight/2 );
      },
      render: function() {
        // Nodes
        var processes = this.state.graph.processes;
        var nodeKeys = Object.keys(processes);
        var nodes = nodeKeys.map(function (key) {
          var process = processes[key];
          return NofloNode({
            name: key, 
            process: process
          });
        });

        // Edges
        var connections = this.state.graph.connections;
        var edges = connections.map(function (connection) {
          if (connection.data !== undefined) {
            // IIP
            return;
          }
          var source = processes[connection.src.process];
          var target = processes[connection.tgt.process];
          return NofloEdge({
            connection: connection,
            source: source,
            target: target,
          });
        });

        // pan and zoom
        var sc = this.state.scale;
        var x = this.state.x;
        var y = this.state.y;
        var transform = "matrix("+sc+",0,0,"+sc+","+x+","+y+")";

        var app = React.DOM.div(
          {
            name:"app", 
            width: 2000, 
            height: 1500,
            onWheel: this.onWheel
          },
          React.DOM.svg(
            {
              name:"graph", 
              width: 2000, 
              height: 1500
            },
            React.DOM.g(
              {
                name: "view",
                transform: transform
              },
              React.DOM.g({
                name:"edges",
                children: edges
              }),
              React.DOM.g({
                name:"nodes", 
                children: nodes
              })
            )
          )
        );
        return app;
      }
    });

    window.loadGraph = function (graph) {
      React.renderComponent(
        NofloGraph({graph:graph}),
        document.getElementById("app")
      );
    };

    window.onload = function () {
      var script = document.createElement('script');
      script.src = 'react-svg-graph.json.js';
      document.head.appendChild(script);
    }

  })();
  </script>

</head>
<body>
  <div id="app"></div>
  <div style="position:absolute; top:0; left:0;">
    <a href="https://github.com/forresto/prototyping/blob/gh-pages/react-svg.html">source</a><br/>
    wheel to zoom<br/>
    space+wheel (or drag) to pan
  </div>
</body>
</html>