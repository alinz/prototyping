<!DOCTYPE html>
<html>
<head>
  <title>react + svg test</title>
  <style>
    body {
      padding: 0;
      margin: 0;
      background-color: hsl(0, 0%, 10%);
      font-family: monospace;
    }
    a {
      color: white;
    }
    rect {
      fill: hsla(0, 0%, 0%, 0.75);
      stroke: hsl(0, 0%, 50%);
      stroke-width: 1px;
    }
    path.edge-bg {
      fill: none;
      stroke: black;
      stroke-width: 4px;
    }
    path.edge-fg {
      fill: none;
      stroke: white;
      stroke-width: 2px;
    }
  </style>
  <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.8.0/react.js"></script>
  <script type="text/javascript">

    var NofloNode = React.createClass({
      render: function() {
        return (
          React.DOM.rect({
            x: this.props.process.metadata.x,
            y: this.props.process.metadata.y,
            width: 72,
            height: 72,
            rx: 8,
            ry: 8
          })
        );
      }
    });

    var NofloEdge = React.createClass({
      componentWillMount: function() {
        // Todo: listen for source/target moving; change state
      },
      render: function() {
        var sourceX = this.props.source.metadata.x + 72;
        var sourceY = this.props.source.metadata.y + 36;
        var targetX = this.props.target.metadata.x + 0;
        var targetY = this.props.target.metadata.y + 36;
        var curve = 50;
        var path = [
          "M",
          sourceX, sourceY,
          "C",
          sourceX + curve, sourceY,
          targetX - curve, targetY,
          targetX, targetY
        ].join(" ");
        return (
          React.DOM.g(
            {className: "edge"},
            React.DOM.path({
              className: "edge-bg",
              d: path
            }),
            React.DOM.path({
              className: "edge-fg",
              d: path
            })
          )
        );
      }
    });

    var NofloGraph = React.createClass({
      getInitialState: function() {
        return {
          graph: this.props.graph
        };
      },
      render: function() {
        var processes = this.state.graph.processes;
        var nodeKeys = Object.keys(processes);
        var nodes = nodeKeys.map(function (key) {
          var process = processes[key];
          return NofloNode({
            name: key, 
            process: process
          });
        });
        var connections = this.state.graph.connections;
        var edges = connections.map(function (connection) {
          if (connection.data !== undefined) {
            // IIP
            return;
          }
          var source = processes[connection.src.process];
          var target = processes[connection.tgt.process];
          return NofloEdge({
            connection: connection,
            source: source,
            target: target,
          });
        });
        console.log(nodes, edges);
        return (
          React.DOM.svg(
            {
              name:"graph", 
              width: 2000, 
              height: 1500
            },
            React.DOM.g({
              name:"edges",
              children: edges
            }),
            React.DOM.g({
              name:"nodes", 
              children: nodes
            })
          )
        );
      }
    });

    window.loadGraph = function (graph) {
      React.renderComponent(
        NofloGraph({graph:graph}),
        document.getElementById("graph")
      );
    };

    window.onload = function () {
      var script = document.createElement('script');
      script.src = 'react-svg-graph.json.js';
      document.head.appendChild(script);
    }

  </script>

</head>
<body>
  <div id="graph"></div>
  <div style="position:absolute; top:0; left:0;"><a href="https://github.com/forresto/prototyping/blob/gh-pages/react-svg.html">source</a></div>
</body>
</html>